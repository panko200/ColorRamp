<UserControl x:Class="ColorRamp.GradientEditorControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ColorRamp"
             xmlns:y="clr-namespace:YukkuriMovieMaker.Controls;assembly=YukkuriMovieMaker.Controls"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             mc:Ignorable="d" 
             d:DesignWidth="300" d:DesignHeight="300">
    <UserControl.Resources>
        <local:GradientPositionConverter x:Key="PosConverter"/>
        <local:PercentConverter x:Key="PercentConverter"/>
    </UserControl.Resources>

    <StackPanel>
        <DockPanel Margin="0,0,0,5" LastChildFill="False">
            <TextBlock Text="ä½ç½®èª¿æ•´:" VerticalAlignment="Center" Foreground="#AAA" Margin="0,0,5,0"/>
            <Button Content="å‡ç­‰" Command="{Binding DistributeCommand}" IsEnabled="{Binding CanDistribute}" Padding="5,2" Margin="0,0,5,0"
                    ToolTip="ä¸¡ç«¯ã‚’å›ºå®šã—ã¦é–“ã‚’å‡ç­‰ã«é…ç½®ã—ã¾ã™"/>
            <Button Content="åè»¢" Command="{Binding ReverseCommand}" IsEnabled="{Binding CanReverse}" Padding="5,2"
                    ToolTip="ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸¦ã³ã‚’åè»¢ã—ã¾ã™"/>
        </DockPanel>
        
        <Grid Height="35" Margin="0,0,0,8">
            <Border BorderBrush="#555" BorderThickness="1" CornerRadius="2" 
                    Height="26" VerticalAlignment="Bottom"
                    MouseLeftButtonDown="GradientPreview_MouseLeftButtonDown"
                    Margin="0,0,8,0"
                    Cursor="Hand">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0" 
                                         GradientStops="{Binding GradientStops}"/>
                </Border.Background>
            </Border>
            <ItemsControl ItemsSource="{Binding Points}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas x:Name="ThumbCanvas" 
                                Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Grid}}"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Left">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource PosConverter}">
                                    <Binding Path="Position" />
                                    <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Canvas}"/>
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Canvas.Top" Value="0"/>
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Thumb DragDelta="Thumb_DragDelta" 
                               DragStarted="Thumb_DragStarted"
                               DragCompleted="Thumb_DragCompleted">
                            <Thumb.Template>
                                <ControlTemplate>
                                    <Grid Background="Transparent">
                                        <Path Data="M 0,0 L 10,0 L 10,10 L 5,15 L 0,10 Z" 
                                              Fill="White" Stroke="#555" StrokeThickness="1"
                                              Margin="-5,0,0,0"/>
                                    </Grid>
                                </ControlTemplate>
                            </Thumb.Template>
                        </Thumb>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>

        <ItemsControl ItemsSource="{Binding Points}">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="0,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="30"/>
                        </Grid.ColumnDefinitions>

                        <!-- â˜…å¤‰æ›´: KeyDownã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  -->
                        <TextBox Grid.Column="0" Margin="0,0,5,0"
                                 Text="{Binding Position, Converter={StaticResource PercentConverter}, UpdateSourceTrigger=LostFocus}"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Right"
                                 KeyDown="TextBox_KeyDown">
                            <i:Interaction.Triggers>
                                <i:EventTrigger EventName="GotFocus">
                                    <i:InvokeCommandAction Command="{Binding BeginEditCommand}"/>
                                </i:EventTrigger>
                                <i:EventTrigger EventName="LostFocus">
                                    <i:InvokeCommandAction Command="{Binding EndEditCommand}"/>
                                </i:EventTrigger>
                            </i:Interaction.Triggers>
                        </TextBox>

                        <y:ColorPicker Grid.Column="1" Height="26" 
                                       Value="{Binding Color, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                       EndEdit="ColorPicker_EndEdit">
                            <i:Interaction.Triggers>
                                <i:EventTrigger EventName="BeginEdit">
                                    <i:InvokeCommandAction Command="{Binding BeginEditCommand}"/>
                                </i:EventTrigger>
                                <i:EventTrigger EventName="EndEdit">
                                    <i:InvokeCommandAction Command="{Binding EndEditCommand}"/>
                                </i:EventTrigger>
                            </i:Interaction.Triggers>
                        </y:ColorPicker>

                        <Button Grid.Column="2" Content="ðŸ—‘" FontSize="14"
                                Margin="4,0,0,0"
                                Background="Transparent" BorderBrush="Transparent" Foreground="#DDD"
                                Command="{Binding DataContext.RemoveCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                IsEnabled="{Binding DataContext.CanRemove, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"/>
                    </Grid>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </StackPanel>
</UserControl>

  